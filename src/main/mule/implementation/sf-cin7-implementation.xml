<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:http="http://www.mulesoft.org/schema/mule/http"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd 
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	<sub-flow name="sf-cin7-implementationSub_Flow" doc:id="652a8f34-87ee-41b0-ae1f-4e0a15b51abc" >
		<try doc:name="Try" doc:id="35883cd7-969d-4490-a7de-aca78a76a7c8" >
			<set-variable value="#[payload]" doc:name="requestPayload" doc:id="9ad2f3b5-a245-43ef-864d-bf9321e3f60b" variableName="requestPayload" />
			<ee:dynamic-evaluate doc:name="Set Payload" doc:id="088cf8cd-7200-4e66-8900-64f50c7c12ba" expression="#[readUrl(&quot;classpath://dwls/&quot; ++ (vars.requestPayload.dwl as String) ++ &quot;.dwl&quot;, 'text/plain')]" />
			<!-- [STUDIO:"Set Payload"]<set-payload value='#[%dw 2.0&#10;output application/json&#10;&#45;&#45;-&#10;{&#10;  "Name": "Test Account 29th April 5",&#10;  "Currency": "AUD",&#10;  "PaymentTerm": "30 Days",&#10;  "Discount": 0,&#10;  "TaxRule": "WEG",&#10;  "Carrier": "Default Carrier",&#10;  "SalesRepresentative": null,&#10;  "Location": "14 Degrees",&#10;  "Comments": "Testing comments",&#10;  "AccountReceivable": "610",&#10;  "RevenueAccount": "200",&#10;  "PriceTier": "Wholesale",&#10;  "TaxNumber": null,&#10;  "AttributeSet": "Customer Attributes",&#10;  "Tags": "Test Tag",&#10;  "Status": "Active",&#10;  "CreditLimit": 2000,&#10;  "IsOnCreditHold": true,&#10;  "LastModifiedOn": "2024-04-29T05:48:04.000Z",&#10;  "AdditionalAttribute1": "",&#10;  "AdditionalAttribute2": "",&#10;  "AdditionalAttribute3": "",&#10;  "AdditionalAttribute4": "",&#10;  "AdditionalAttribute5": "",&#10;  "AdditionalAttribute6": "",&#10;  "AdditionalAttribute7": "",&#10;  "AdditionalAttribute8": "",&#10;  "AdditionalAttribute9": "",&#10;  "AdditionalAttribute10": "",&#10;  "Addresses": [&#10;    &#10;  &#93;,&#10;  "Contacts": [&#10;    &#10;  &#93;&#10;}&#93;' doc:name="Set Payload" doc:id="07dab11c-7281-4bae-a0d9-b0398c678246" /> [STUDIO] -->
			<logger level="DEBUG" doc:name="Log Outbound" doc:id="1235c6d3-0bd1-40c5-83bf-c657ae1f02dd" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;  flowName: flow.name,&#10;  apiName: app.name,&#10;  Name: "Log Outbound",&#10;  MetaData: "Request to cin system api started",&#10;  correlationId: correlationId,&#10;  data: payload&#10;}]' />
			<until-successful maxRetries="5" doc:name="Until Successful" doc:id="86a9fdf6-90a0-4df9-afa2-dedef669145f">
			<http:request method="#[vars.requestPayload.httpRequest.method]" doc:name="Cin7-Sys-Api" doc:id="83ada24a-e3fc-46e3-b2c7-d93d503e833e" url='#[(vars.requestPayload.httpRequest.protocol as String) ++ "://" ++ (vars.requestPayload.httpRequest.host as String)  ++ (vars.requestPayload.httpRequest.url as String)]' >
					<http:headers ><![CDATA[#[output application/java
---
vars.requestPayload.httpRequest.headers]]]></http:headers>
					<http:response-validator >
						<http:success-status-code-validator values="${request.response.values}"/>
					</http:response-validator>
				</http:request>
		</until-successful>
			<logger level="DEBUG" doc:name="Log Inbound" doc:id="8ffdc2a5-ebfc-4593-84b0-10eda5468b1b" message='#[%dw 2.0&#10;output application/json&#10;---&#10;{&#10;  flowName: flow.name,&#10;  apiName: app.name,&#10;  Name: "Log Inbound",&#10;  MetaData: "Request to cin system api completed",&#10;  correlationId: correlationId,&#10;  data: payload&#10;}]'/>
			<choice doc:name="Choice" doc:id="a9c47974-fd5c-468c-b084-ce44c5945431" >
				<when expression="#[attributes.statusCode == 200 or attributes.statusCode == 201]">
					<ee:dynamic-evaluate doc:name="SF Request" doc:id="4c2a7c2b-8c61-4f0a-99f4-bd7e0e130b58" expression="#[readUrl(&quot;classpath://dwls/&quot; ++ (vars.requestPayload.responseDwl as String) ++ &quot;.dwl&quot;, 'text/plain')]"/>
					<flow-ref doc:name="request-to-salesforce-upsert-subflow" doc:id="0541afa4-8ffe-4923-b631-0f5914a69b40" name="request-to-salesforce-upsert-subflow" />
				</when>
				<otherwise >
					<ee:dynamic-evaluate doc:name="Error SF Request" doc:id="b75f5ce5-c485-402d-a723-747f99560524" expression="#[readUrl(&quot;classpath://dwls/&quot; ++ (vars.requestPayload.errDwl as String) ++ &quot;.dwl&quot;, 'text/plain')]"/>
					<flow-ref doc:name="request-to-salesforce-upsert-subflow" doc:id="9655d84c-44b1-4983-99a5-e8749f13cea1" name="request-to-salesforce-upsert-subflow"/>
					<flow-ref doc:name="send-email-subflow" doc:id="329b6a0a-28c0-4434-9d62-6e447147b4a8" name="send-email-subflow"/>
				</otherwise>
			</choice>
			<error-handler >
				<on-error-propagate enableNotifications="true" logException="true" doc:name="On Error Propagate" doc:id="c722eb95-f04e-4629-8896-c68167e606e4" >
					<set-variable value='#["Error while processing the create request in Cin-process-API !!"]' doc:name="errorContext" doc:id="7736acdc-1ad7-4573-9223-5ae19d0c5bb1" variableName="errorContext"/>
					<flow-ref doc:name="send-email-subflow" doc:id="5da41f3e-bf00-41cd-a4f7-83b2e29e9762" name="send-email-subflow"/>
				</on-error-propagate>
			</error-handler>
		</try>

	</sub-flow>
</mule>
